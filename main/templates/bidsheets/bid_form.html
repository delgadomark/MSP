{% extends "main/base.html" %}
{% load static %}

{% block title %}{% if object %}Edit Bid{% else %}Create Bid{% endif %}{% endblock title %}

{% block extra_head_content %}
<style>
    .item-total {
        background-color: #f8f9fa !important;
        font-weight: bold;
        color: #28a745;
    }

    .bid-item-form {
        transition: background-color 0.3s ease;
    }

    .bid-item-form:hover {
        background-color: #f8f9fa;
    }

    #total-display .card-body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    #display-total {
        font-size: 1.2em;
    }

    .calculation-highlight {
        background-color: #fff3cd !important;
        transition: background-color 0.5s ease;
    }

    .new-form-highlight {
        background-color: #d1ecf1 !important;
        transition: background-color 2s ease;
    }
</style>
{% endblock extra_head_content %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>{% if object %}Edit Bid - {{ object.bid_number }}{% else %}Create New Bid{% endif %}</h1>
                <a href="{% url 'bid_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>

            {% if selected_customer %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i>
                <strong>Customer Pre-selected:</strong> Creating bid for {{ selected_customer.name }}{% if selected_customer.company %} ({{ selected_customer.company }}){% endif %}.
                Customer information has been auto-populated.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <form method="post" id="bid-form">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-8">
                        <!-- Basic Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                            {{ form.title }}
                                            {% if form.title.help_text %}
                                                <div class="form-text">{{ form.title.help_text }}</div>
                                            {% endif %}
                                            {% if form.title.errors %}
                                                <div class="text-danger">{{ form.title.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
                                            {{ form.customer }}
                                            <div class="form-text">
                                                <a href="{% url 'customer_create' %}" target="_blank">Add new customer</a>
                                            </div>
                                            {% if form.customer.errors %}
                                                <div class="text-danger">{{ form.customer.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.project_description.id_for_label }}" class="form-label">{{ form.project_description.label }}</label>
                                    {{ form.project_description }}
                                    {% if form.project_description.errors %}
                                        <div class="text-danger">{{ form.project_description.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.project_address.id_for_label }}" class="form-label">{{ form.project_address.label }}</label>
                                    {{ form.project_address }}
                                    {% if selected_customer and selected_customer.address %}
                                        <div class="form-text text-info">
                                            <i class="fas fa-info-circle"></i> Auto-populated from customer address
                                        </div>
                                    {% endif %}
                                    {% if form.project_address.errors %}
                                        <div class="text-danger">{{ form.project_address.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.valid_until.id_for_label }}" class="form-label">{{ form.valid_until.label }}</label>
                                    {{ form.valid_until }}
                                    {% if form.valid_until.errors %}
                                        <div class="text-danger">{{ form.valid_until.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Bid Items -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Bid Items</h5>
                            </div>
                            <div class="card-body">
                                {{ formset.management_form }}
                                <div id="bid-items">
                                    {% for form in formset %}
                                        <div class="bid-item-form border rounded p-3 mb-3">
                                            {{ form.id }}
                                            {% if form.DELETE %}
                                                <div class="form-check">
                                                    {{ form.DELETE }}
                                                    <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                        Delete this item
                                                    </label>
                                                </div>
                                            {% endif %}

                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="mb-3">
                                                        <label for="{{ form.service_item.id_for_label }}" class="form-label">Service Item</label>
                                                        {{ form.service_item }}
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="mb-3">
                                                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                                        {{ form.description }}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label for="{{ form.quantity.id_for_label }}" class="form-label">Quantity</label>
                                                        {{ form.quantity }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label for="{{ form.unit_type.id_for_label }}" class="form-label">Unit</label>
                                                        {{ form.unit_type }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label for="{{ form.unit_price.id_for_label }}" class="form-label">Unit Price</label>
                                                        {{ form.unit_price }}
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label">Total</label>
                                                        <input type="text" class="form-control item-total" readonly />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="alert alert-info" id="no-items-message">
                                            <i class="fas fa-info-circle"></i>
                                            <strong>No items added yet.</strong> Click "Add Item" below to start building your bid.
                                        </div>
                                    {% endfor %}
                                </div>

                                <button type="button" class="btn btn-outline-primary" id="add-item" onclick="addNewItem();">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>

                        <!-- Hidden template form for cloning -->
                        <template id="empty-form-template">
                            <div class="bid-item-form border rounded p-3 mb-3">
                                <input type="hidden" name="items-__prefix__-id" id="id_items-__prefix__-id" />

                                <div class="form-check">
                                    <input type="checkbox" name="items-__prefix__-DELETE" class="form-check-input" id="id_items-__prefix__-DELETE" />
                                    <label class="form-check-label text-danger" for="id_items-__prefix__-DELETE">
                                        Delete this item
                                    </label>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="id_items-__prefix__-service_item" class="form-label">Service Item</label>
                                            <select name="items-__prefix__-service_item" class="form-select" id="id_items-__prefix__-service_item">
                                                <option value="">Select a service item...</option>
                                                {% for item in service_items %}
                                                    <option value="{{ item.id }}">{{ item.category.name }} - {{ item.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="id_items-__prefix__-description" class="form-label">Description</label>
                                            <textarea name="items-__prefix__-description" class="form-control" rows="2" id="id_items-__prefix__-description"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="id_items-__prefix__-quantity" class="form-label">Quantity</label>
                                            <input type="number" name="items-__prefix__-quantity" class="form-control" step="0.01" min="0" id="id_items-__prefix__-quantity" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="id_items-__prefix__-unit_type" class="form-label">Unit</label>
                                            <input type="text" name="items-__prefix__-unit_type" class="form-control" maxlength="20" id="id_items-__prefix__-unit_type" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="id_items-__prefix__-unit_price" class="form-label">Unit Price</label>
                                            <input type="number" name="items-__prefix__-unit_price" class="form-control" step="0.01" min="0" id="id_items-__prefix__-unit_price" />
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">Total</label>
                                            <input type="text" class="form-control item-total" readonly />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-4">
                        <!-- Financial Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Financial</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.discount_percentage.id_for_label }}" class="form-label">{{ form.discount_percentage.label }}</label>
                                    {{ form.discount_percentage }}
                                    {% if form.discount_percentage.errors %}
                                        <div class="text-danger">{{ form.discount_percentage.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.tax_percentage.id_for_label }}" class="form-label">{{ form.tax_percentage.label }}</label>
                                    {{ form.tax_percentage }}
                                    {% if form.tax_percentage.errors %}
                                        <div class="text-danger">{{ form.tax_percentage.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Terms & Conditions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Terms & Conditions</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="{{ form.custom_terms.id_for_label }}" class="form-label">{{ form.custom_terms.label }}</label>
                                    {{ form.custom_terms }}
                                    {% if form.custom_terms.errors %}
                                        <div class="text-danger">{{ form.custom_terms.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.custom_exclusions.id_for_label }}" class="form-label">{{ form.custom_exclusions.label }}</label>
                                    {{ form.custom_exclusions }}
                                    {% if form.custom_exclusions.errors %}
                                        <div class="text-danger">{{ form.custom_exclusions.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-danger">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> {% if object %}Update Bid{% else %}Create Bid{% endif %}
                                </button>
                                <a href="{% url 'bid_list' %}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Simple working Add Item function
function addNewItem() {
    // Get current form count
    const totalFormsInput = document.querySelector('#id_items-TOTAL_FORMS');
    if (!totalFormsInput) {
        alert('Error: Could not find TOTAL_FORMS input');
        return;
    }

    const formIdx = parseInt(totalFormsInput.value);

    // Get the template
    const template = document.getElementById('empty-form-template');
    if (!template) {
        alert('Error: Could not find template');
        return;
    }

    // Clone the template content
    const templateContent = template.content.cloneNode(true);
    const newForm = templateContent.querySelector('.bid-item-form');

    if (!newForm) {
        alert('Error: Could not find form in template');
        return;
    }

    // Update the form indexes
    updateFormIndexes(newForm, formIdx);

    // Add to container
    const container = document.getElementById('bid-items');
    if (!container) {
        alert('Error: Could not find container');
        return;
    }

    container.appendChild(newForm);

    // Hide no items message
    const noItemsMsg = document.getElementById('no-items-message');
    if (noItemsMsg) {
        noItemsMsg.style.display = 'none';
    }

    // Update total forms count
    totalFormsInput.value = formIdx + 1;

    // Add visual highlight to new form
    newForm.classList.add('new-form-highlight');
    setTimeout(() => {
        newForm.classList.remove('new-form-highlight');
    }, 2000);

    // Scroll to the new form
    newForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
}

// Simple function to update form indexes
function updateFormIndexes(formElement, newIndex) {
    // Update name attributes
    const nameElements = formElement.querySelectorAll('[name*="__prefix__"]');
    for (let i = 0; i < nameElements.length; i++) {
        const element = nameElements[i];
        const name = element.getAttribute('name');
        element.setAttribute('name', name.replace('__prefix__', newIndex));
    }

    // Update id attributes
    const idElements = formElement.querySelectorAll('[id*="__prefix__"]');
    for (let i = 0; i < idElements.length; i++) {
        const element = idElements[i];
        const id = element.getAttribute('id');
        element.setAttribute('id', id.replace('__prefix__', newIndex));
    }

    // Update for attributes in labels
    const labelElements = formElement.querySelectorAll('label[for*="__prefix__"]');
    for (let i = 0; i < labelElements.length; i++) {
        const element = labelElements[i];
        const forAttr = element.getAttribute('for');
        element.setAttribute('for', forAttr.replace('__prefix__', newIndex));
    }
}
</script>
{% endblock content %}
